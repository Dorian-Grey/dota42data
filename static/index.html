<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOTA4+2 é£é¾™åœ¨å¤©-å¯¹é»‘ç§¯åˆ†ç³»ç»Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #131a26;
            --bg-card: #1a2332;
            --bg-hover: #243044;
            --accent-gold: #f5a623;
            --accent-red: #e74c3c;
            --accent-green: #2ecc71;
            --accent-blue: #3498db;
            --accent-purple: #9b59b6;
            --text-primary: #ecf0f1;
            --text-secondary: #95a5a6;
            --text-muted: #5d6d7e;
            --border-color: #2c3e50;
            --radiant-color: #7cb342;
            --dire-color: #c62828;
            --shadow-glow: 0 0 30px rgba(245, 166, 35, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at top left, rgba(245, 166, 35, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(155, 89, 182, 0.05) 0%, transparent 50%),
                linear-gradient(180deg, var(--bg-primary) 0%, #0d1320 100%);
        }

        /* Header */
        header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #ffd93d 50%, var(--accent-gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(245, 166, 35, 0.5);
            letter-spacing: 2px;
        }

        .logo span {
            font-size: 0.9rem;
            color: var(--text-secondary);
            -webkit-text-fill-color: var(--text-secondary);
            font-family: 'Noto Sans SC', sans-serif;
            font-weight: 400;
            margin-left: 0.5rem;
        }

        /* Navigation */
        nav {
            display: flex;
            gap: 0.5rem;
        }

        nav button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        nav button:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            background: rgba(245, 166, 35, 0.1);
        }

        nav button.active {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #e6951d 100%);
            border-color: var(--accent-gold);
            color: var(--bg-primary);
        }

        /* Main Content */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-glow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* Upload Section */
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(26, 35, 50, 0.5);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent-gold);
            background: rgba(245, 166, 35, 0.05);
        }

        .upload-zone svg {
            width: 64px;
            height: 64px;
            fill: var(--text-muted);
            margin-bottom: 1rem;
        }

        .upload-zone h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-zone p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        #fileInput {
            display: none;
        }

        /* Preview */
        .preview-container {
            display: none;
            margin-top: 1.5rem;
        }

        .preview-container.visible {
            display: block;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .team-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .team-badge.radiant {
            background: linear-gradient(135deg, var(--radiant-color) 0%, #558b2f 100%);
        }

        .team-badge.dire {
            background: linear-gradient(135deg, var(--dire-color) 0%, #8e0000 100%);
        }

        .winner-select {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .winner-btn {
            flex: 1;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .winner-btn:hover {
            border-color: var(--text-secondary);
        }

        .winner-btn.radiant.selected {
            border-color: var(--radiant-color);
            background: rgba(124, 179, 66, 0.2);
            color: var(--radiant-color);
        }

        .winner-btn.dire.selected {
            border-color: var(--dire-color);
            background: rgba(198, 40, 40, 0.2);
            color: var(--dire-color);
        }

        /* Player Input */
        .player-inputs {
            display: grid;
            gap: 0.75rem;
        }

        .player-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.75rem;
            align-items: center;
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .player-row input {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .player-row input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .player-row input::placeholder {
            color: var(--text-muted);
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .tag-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .tag-btn:hover {
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }

        .tag-btn.selected {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--bg-primary);
        }

        .tag-btn.mvp.selected {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
        }

        .tag-btn.svp.selected {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }

        .tag-btn.jiang.selected {
            background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
        }

        .tag-btn.bai.selected {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        /* Buttons */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #e6951d 100%);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 166, 35, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red) 0%, #c0392b 100%);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Leaderboard Table */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .leaderboard-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .leaderboard-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .leaderboard-table th.sortable:hover {
            color: var(--accent-gold);
            background: var(--bg-hover);
        }

        .sort-icon {
            font-size: 0.75rem;
            margin-left: 0.3rem;
            opacity: 0.5;
        }

        .sort-icon.active {
            opacity: 1;
            color: var(--accent-gold);
        }

        .leaderboard-table tr:hover td {
            background: var(--bg-hover);
        }

        .leaderboard-table .rank {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .player-name {
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .player-name:hover {
            color: var(--accent-gold);
        }

        .score {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .score.positive { color: var(--accent-green); }
        .score.negative { color: var(--accent-red); }
        .score.zero { color: var(--text-muted); }

        .win-rate {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .win-rate-bar {
            width: 60px;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
        }

        .win-rate-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green) 0%, #27ae60 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .tag-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.3rem;
        }

        .tag-badge.mvp { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .tag-badge.svp { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; }
        .tag-badge.jiang { background: #7f8c8d; color: #fff; }
        .tag-badge.bai { background: #e74c3c; color: #fff; }

        /* Match History */
        .match-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .match-card:hover {
            border-color: var(--accent-gold);
            box-shadow: var(--shadow-glow);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .match-date {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .match-result {
            display: flex;
            gap: 2rem;
        }

        .match-team {
            flex: 1;
        }

        .match-team h5 {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .match-team.winner h5::after {
            content: 'ğŸ‘‘';
            font-size: 1rem;
        }

        .match-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid rgba(44, 62, 80, 0.5);
        }

        .match-player:last-child {
            border-bottom: none;
        }

        .match-player-name {
            color: var(--text-primary);
        }

        .match-player-tags {
            display: flex;
            gap: 0.3rem;
        }

        /* Player Detail Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.visible {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.3rem;
        }

        .relation-section {
            margin-top: 1.5rem;
        }

        .relation-section h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .relation-table {
            width: 100%;
            border-collapse: collapse;
        }

        .relation-table th,
        .relation-table td {
            padding: 0.6rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .relation-table th {
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 2000;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-top: 0.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.success {
            border-color: var(--accent-green);
        }

        .toast.error {
            border-color: var(--accent-red);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.visible {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            fill: var(--text-muted);
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .match-result {
                flex-direction: column;
                gap: 1rem;
            }

            .stat-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .player-row {
                grid-template-columns: 1fr;
            }

            .winner-select {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                DOTA4+2<span>é£é¾™åœ¨å¤©-å¯¹é»‘ç§¯åˆ†ç³»ç»Ÿ</span>
            </div>
            <nav>
                <button class="active" onclick="showPage('upload')">ğŸ“¤ å½•å…¥æ¯”èµ›</button>
                <button onclick="showPage('leaderboard')">ğŸ† ç§¯åˆ†æ¦œ</button>
                <button onclick="showPage('history')">ğŸ“œ æ¯”èµ›è®°å½•</button>
                <button onclick="exportData()">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
                <button onclick="showApiKeyModal()">âš™ï¸ è®¾ç½®</button>
            </nav>
        </div>
    </header>

    <main>
        <!-- å½•å…¥æ¯”èµ›é¡µé¢ -->
        <div id="page-upload" class="page active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ“¸ ä¸Šä¼ æ¯”èµ›æˆªå›¾</h2>
                </div>
                
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <svg viewBox="0 0 24 24">
                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                    <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æˆªå›¾</h3>
                    <p>æ”¯æŒ PNG, JPG, JPEG, GIF, WEBP æ ¼å¼</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
                
                <div class="preview-container" id="previewContainer">
                    <img id="previewImage" class="preview-image" alt="é¢„è§ˆ">
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">âœï¸ æ‰‹åŠ¨å½•å…¥æ¯”èµ›ä¿¡æ¯</h2>
                </div>
                
                <div class="form-section">
                    <h4>ğŸ† é€‰æ‹©è·èƒœæ–¹</h4>
                    <div class="winner-select">
                        <button class="winner-btn radiant" onclick="selectWinner('å¤©è¾‰')">
                            ğŸŒ¿ å¤©è¾‰ (Radiant)
                        </button>
                        <button class="winner-btn dire" onclick="selectWinner('å¤œé­”')">
                            ğŸ”¥ å¤œé­” (Dire)
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="swapTeams()" style="margin-top: 1rem; width: 100%;">
                        ğŸ”„ ä¸€é”®äº¤æ¢é˜µè¥ï¼ˆå¤©è¾‰ â†” å¤œé­”ï¼‰
                    </button>
                </div>

                <div class="form-section">
                    <h4><span class="team-badge radiant">å¤©è¾‰</span> ç©å®¶åˆ—è¡¨</h4>
                    <div class="player-inputs" id="radiantPlayers">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="form-section">
                    <h4><span class="team-badge dire">å¤œé­”</span> ç©å®¶åˆ—è¡¨</h4>
                    <div class="player-inputs" id="direPlayers">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="submitMatch()">âœ… æäº¤æ¯”èµ›è®°å½•</button>
                    <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ é‡ç½®è¡¨å•</button>
                </div>
            </div>
        </div>

        <!-- ç§¯åˆ†æ¦œé¡µé¢ -->
        <div id="page-leaderboard" class="page">
            <div class="card" id="leaderboardCard">
                <div class="card-header">
                    <h2 class="card-title">ğŸ† ç§¯åˆ†æ’è¡Œæ¦œ</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="loadLeaderboard()">ğŸ”„ åˆ·æ–°</button>
                        <button class="btn btn-primary" onclick="exportLeaderboardImage()">ğŸ“· å¯¼å‡ºé•¿å›¾</button>
                    </div>
                </div>
                
                <div class="loading" id="leaderboardLoading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
                
                <div id="leaderboardContent">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('rank')">æ’å <span class="sort-icon" id="sort-rank">â†•</span></th>
                                <th class="sortable" onclick="sortTable('name')">ç©å®¶ <span class="sort-icon" id="sort-name">â†•</span></th>
                                <th class="sortable" onclick="sortTable('score')">ç§¯åˆ† <span class="sort-icon" id="sort-score">â†•</span></th>
                                <th class="sortable" onclick="sortTable('total_games')">æ€»åœºæ¬¡ <span class="sort-icon" id="sort-total_games">â†•</span></th>
                                <th class="sortable" onclick="sortTable('wins')">èƒœåœº <span class="sort-icon" id="sort-wins">â†•</span></th>
                                <th class="sortable" onclick="sortTable('losses')">è´Ÿåœº <span class="sort-icon" id="sort-losses">â†•</span></th>
                                <th class="sortable" onclick="sortTable('win_rate')">èƒœç‡ <span class="sort-icon" id="sort-win_rate">â†•</span></th>
                                <th class="sortable" onclick="sortTable('mvp_count')">MVP <span class="sort-icon" id="sort-mvp_count">â†•</span></th>
                                <th class="sortable" onclick="sortTable('svp_count')">SVP <span class="sort-icon" id="sort-svp_count">â†•</span></th>
                                <th class="sortable" onclick="sortTable('jiang_count')">åƒµ <span class="sort-icon" id="sort-jiang_count">â†•</span></th>
                                <th class="sortable" onclick="sortTable('horse_value')">é©¬åŒ¹ <span class="sort-icon" id="sort-horse_value">â†•</span></th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="empty-state" id="leaderboardEmpty" style="display: none;">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <h3>æš‚æ— æ•°æ®</h3>
                    <p>è¯·å…ˆå½•å…¥æ¯”èµ›è®°å½•</p>
                </div>
            </div>
        </div>

        <!-- æ¯”èµ›è®°å½•é¡µé¢ -->
        <div id="page-history" class="page">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ“œ æ¯”èµ›è®°å½•</h2>
                    <button class="btn btn-secondary" onclick="loadMatches()">ğŸ”„ åˆ·æ–°</button>
                </div>
                
                <div class="loading" id="historyLoading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
                
                <div id="historyContent">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="empty-state" id="historyEmpty" style="display: none;">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    <h3>æš‚æ— æ¯”èµ›è®°å½•</h3>
                    <p>è¯·å…ˆå½•å…¥æ¯”èµ›</p>
                </div>
            </div>
        </div>
    </main>

    <!-- ç©å®¶è¯¦æƒ…å¼¹çª— -->
    <div class="modal-overlay" id="playerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalPlayerName">ç©å®¶è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- Toastå®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ç¼–è¾‘æ¯”èµ›å¼¹çª— -->
    <div class="modal-overlay" id="editMatchModal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">âœï¸ ç¼–è¾‘æ¯”èµ›è®°å½• <span id="editMatchId" style="color: var(--text-muted); font-size: 0.9rem;"></span></h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>ğŸ† è·èƒœæ–¹</h4>
                    <div class="winner-select">
                        <button class="winner-btn radiant" id="editWinnerRadiant" onclick="selectEditWinner('å¤©è¾‰')">
                            ğŸŒ¿ å¤©è¾‰ (Radiant)
                        </button>
                        <button class="winner-btn dire" id="editWinnerDire" onclick="selectEditWinner('å¤œé­”')">
                            ğŸ”¥ å¤œé­” (Dire)
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="swapEditTeams()" style="margin-top: 1rem; width: 100%;">
                        ğŸ”„ ä¸€é”®äº¤æ¢é˜µè¥
                    </button>
                </div>

                <div class="form-section">
                    <h4><span class="team-badge radiant">å¤©è¾‰</span> ç©å®¶åˆ—è¡¨</h4>
                    <div class="player-inputs" id="editRadiantPlayers"></div>
                </div>

                <div class="form-section">
                    <h4><span class="team-badge dire">å¤œé­”</span> ç©å®¶åˆ—è¡¨</h4>
                    <div class="player-inputs" id="editDirePlayers"></div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveMatchEdit()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                    <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Keyè®¾ç½®å¼¹çª— -->
    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">âš™ï¸ è®¾ç½® Gemini API Key</h3>
                <button class="modal-close" onclick="closeApiKeyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    ä½¿ç”¨ Google Gemini API è‡ªåŠ¨è¯†åˆ«æˆªå›¾ä¸­çš„æ¯”èµ›ä¿¡æ¯ã€‚<br>
                    è·å–API Key: <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--accent-gold);">aistudio.google.com/apikey</a>
                </p>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.85rem;">API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-xxxxxxxxxxxxxxxx" 
                           style="width: 100%; padding: 0.8rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem;">
                </div>
                <div class="btn-group" style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="saveApiKey()">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="closeApiKeyModal()">å–æ¶ˆ</button>
                </div>
                <div id="apiKeyStatus" style="margin-top: 1rem; padding: 0.8rem; border-radius: 8px; display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let selectedWinner = '';
        const TAGS = ['MVP', 'SVP', 'åƒµ'];
        
        // æ’åºçŠ¶æ€
        let currentPlayers = [];
        let sortState = { column: 'score', direction: 'desc' };

        // åå­—è‡ªåŠ¨ä¿®æ­£è§„åˆ™
        const NAME_CORRECTIONS = {
            'æ¨ªæ‰‹æ’èµµæ±': 'æ¨ªæ‰‹æ´¾èµµä¸œ',
            'æ¨ªæ‰‹æ’èµµä¸œ': 'æ¨ªæ‰‹æ´¾èµµä¸œ',
            'æ¨ªæ‰‹æ´¾èµµæ±': 'æ¨ªæ‰‹æ´¾èµµä¸œ',
            'æ¨ç©ºæ›²': 'ç‚€ç©ºæ›²',
            'ç•…ç©ºæ›²': 'ç‚€ç©ºæ›²',
            'æ‰¬ç©ºæ›²': 'ç‚€ç©ºæ›²',
            'XDG': 'XD G',
            'XD  G': 'XD G',
        };

        // è‡ªåŠ¨ä¿®æ­£åå­—
        function correctPlayerName(name) {
            if (!name) return name;
            let corrected = name.trim();
            
            // ç²¾ç¡®åŒ¹é…ä¿®æ­£
            if (NAME_CORRECTIONS[corrected]) {
                return NAME_CORRECTIONS[corrected];
            }
            
            // éƒ¨åˆ†åŒ¹é…ä¿®æ­£
            for (const [wrong, right] of Object.entries(NAME_CORRECTIONS)) {
                if (corrected.includes(wrong)) {
                    corrected = corrected.replace(wrong, right);
                }
            }
            
            return corrected;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initPlayerInputs();
            setupDragAndDrop();
            loadLeaderboard();
            checkApiStatus();
        });

        // æ£€æŸ¥APIçŠ¶æ€
        function checkApiStatus() {
            fetch('/api/status')
            .then(res => res.json())
            .then(data => {
                if (!data.api_available) {
                    showToast('è¯·å…ˆè®¾ç½® Gemini API Key ä»¥å¯ç”¨æˆªå›¾è¯†åˆ«åŠŸèƒ½', 'info');
                }
            })
            .catch(() => {});
        }

        // æ˜¾ç¤ºAPI Keyè®¾ç½®å¼¹çª—
        function showApiKeyModal() {
            document.getElementById('apiKeyModal').classList.add('visible');
            document.getElementById('apiKeyInput').focus();
        }

        // å…³é—­API Keyè®¾ç½®å¼¹çª—
        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').classList.remove('visible');
        }

        // ä¿å­˜API Key
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showToast('è¯·è¾“å…¥API Key', 'error');
                return;
            }

            fetch('/api/set_api_key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('API Key è®¾ç½®æˆåŠŸï¼', 'success');
                    closeApiKeyModal();
                    document.getElementById('apiKeyInput').value = '';
                } else {
                    showToast(data.error || 'è®¾ç½®å¤±è´¥', 'error');
                }
            })
            .catch(err => {
                showToast('è®¾ç½®å¤±è´¥: ' + err.message, 'error');
            });
        }

        // ç‚¹å‡»API Keyå¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('apiKeyModal').addEventListener('click', (e) => {
            if (e.target.id === 'apiKeyModal') closeApiKeyModal();
        });

        // é¡µé¢åˆ‡æ¢
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`page-${pageName}`).classList.add('active');
            event.target.classList.add('active');
            
            if (pageName === 'leaderboard') loadLeaderboard();
            if (pageName === 'history') loadMatches();
        }

        // åˆå§‹åŒ–ç©å®¶è¾“å…¥æ¡†
        function initPlayerInputs() {
            const radiantContainer = document.getElementById('radiantPlayers');
            const direContainer = document.getElementById('direPlayers');
            
            radiantContainer.innerHTML = '';
            direContainer.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                radiantContainer.appendChild(createPlayerInput('radiant', i));
                direContainer.appendChild(createPlayerInput('dire', i));
            }
        }

        function createPlayerInput(team, index) {
            const div = document.createElement('div');
            div.className = 'player-row';
            div.innerHTML = `
                <input type="text" id="${team}_player_${index}" placeholder="ç©å®¶åç§°">
                <div class="tags-container">
                    ${TAGS.map(tag => `
                        <button class="tag-btn ${tag.toLowerCase()}" 
                                onclick="toggleTag('${team}', ${index}, '${tag}', this)">
                            ${tag}
                        </button>
                    `).join('')}
                </div>
            `;
            return div;
        }

        // æ ‡ç­¾åˆ‡æ¢
        function toggleTag(team, index, tag, btn) {
            btn.classList.toggle('selected');
        }

        // é€‰æ‹©è·èƒœæ–¹
        function selectWinner(team) {
            selectedWinner = team;
            document.querySelectorAll('.winner-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector(`.winner-btn.${team === 'å¤©è¾‰' ? 'radiant' : 'dire'}`).classList.add('selected');
        }

        // ä¸€é”®äº¤æ¢é˜µè¥
        function swapTeams() {
            // æ”¶é›†å¤©è¾‰ç©å®¶æ•°æ®
            const radiantData = [];
            for (let i = 0; i < 5; i++) {
                const name = document.getElementById(`radiant_player_${i}`).value;
                const tags = [];
                document.querySelectorAll(`#radiantPlayers .player-row:nth-child(${i+1}) .tag-btn.selected`).forEach(btn => {
                    tags.push(btn.textContent.trim());
                });
                radiantData.push({ name, tags });
            }

            // æ”¶é›†å¤œé­”ç©å®¶æ•°æ®
            const direData = [];
            for (let i = 0; i < 5; i++) {
                const name = document.getElementById(`dire_player_${i}`).value;
                const tags = [];
                document.querySelectorAll(`#direPlayers .player-row:nth-child(${i+1}) .tag-btn.selected`).forEach(btn => {
                    tags.push(btn.textContent.trim());
                });
                direData.push({ name, tags });
            }

            // æ¸…ç©ºæ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('selected'));

            // äº¤æ¢ï¼šå¤œé­”æ•°æ®å¡«å…¥å¤©è¾‰
            for (let i = 0; i < 5; i++) {
                document.getElementById(`radiant_player_${i}`).value = direData[i].name;
                direData[i].tags.forEach(tag => {
                    const btn = document.querySelector(`#radiantPlayers .player-row:nth-child(${i+1}) .tag-btn`);
                    document.querySelectorAll(`#radiantPlayers .player-row:nth-child(${i+1}) .tag-btn`).forEach(b => {
                        if (b.textContent.trim() === tag) b.classList.add('selected');
                    });
                });
            }

            // äº¤æ¢ï¼šå¤©è¾‰æ•°æ®å¡«å…¥å¤œé­”
            for (let i = 0; i < 5; i++) {
                document.getElementById(`dire_player_${i}`).value = radiantData[i].name;
                radiantData[i].tags.forEach(tag => {
                    document.querySelectorAll(`#direPlayers .player-row:nth-child(${i+1}) .tag-btn`).forEach(b => {
                        if (b.textContent.trim() === tag) b.classList.add('selected');
                    });
                });
            }

            // äº¤æ¢è·èƒœæ–¹
            if (selectedWinner === 'å¤©è¾‰') {
                selectWinner('å¤œé­”');
            } else if (selectedWinner === 'å¤œé­”') {
                selectWinner('å¤©è¾‰');
            }

            showToast('é˜µè¥å·²äº¤æ¢', 'success');
        }

        // æ–‡ä»¶ä¸Šä¼ 
        function setupDragAndDrop() {
            const zone = document.getElementById('uploadZone');
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) handleFile(file);
        }

        function handleFile(file) {
            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewContainer').classList.add('visible');
            };
            reader.readAsDataURL(file);
            
            // ä¸Šä¼ å¹¶è§£æ
            const formData = new FormData();
            formData.append('file', file);
            
            showToast('æ­£åœ¨ä¸Šä¼ å¹¶è§£æå›¾ç‰‡...', 'info');
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                    if (!data.ocr_available) {
                        showToast('è¯·æ‰‹åŠ¨å½•å…¥æ¯”èµ›ä¿¡æ¯', 'info');
                    }
                } else {
                    showToast('å›¾ç‰‡è§£æå®Œæˆï¼Œè¯·æ ¸å¯¹ä¿¡æ¯', 'success');
                    fillFormWithParsedData(data);
                }
            })
            .catch(err => {
                showToast('ä¸Šä¼ å¤±è´¥: ' + err.message, 'error');
            });
        }

        // å¡«å……è§£ææ•°æ®
        function fillFormWithParsedData(data) {
            if (data.winner) {
                selectWinner(data.winner);
            }
            
            // å¡«å……å¤©è¾‰ç©å®¶
            if (data.radiant_players) {
                data.radiant_players.forEach((player, i) => {
                    if (i < 5) {
                        const input = document.getElementById(`radiant_player_${i}`);
                        if (input && player.name) input.value = player.name;
                        
                        // è®¾ç½®æ ‡ç­¾
                        if (player.tags) {
                            player.tags.forEach(tag => {
                                const btn = document.querySelector(`#radiantPlayers .player-row:nth-child(${i+1}) .tag-btn.${tag.toLowerCase()}`);
                                if (btn) btn.classList.add('selected');
                            });
                        }
                    }
                });
            }
            
            // å¡«å……å¤œé­”ç©å®¶
            if (data.dire_players) {
                data.dire_players.forEach((player, i) => {
                    if (i < 5) {
                        const input = document.getElementById(`dire_player_${i}`);
                        if (input && player.name) input.value = player.name;
                        
                        if (player.tags) {
                            player.tags.forEach(tag => {
                                const btn = document.querySelector(`#direPlayers .player-row:nth-child(${i+1}) .tag-btn.${tag.toLowerCase()}`);
                                if (btn) btn.classList.add('selected');
                            });
                        }
                    }
                });
            }
        }

        // æ£€æŸ¥ç§°å·ä¸€è‡´æ€§
        function checkTagsConsistency(winner, radiantPlayers, direPlayers) {
            const warnings = [];
            const radiantWon = winner === 'å¤©è¾‰';
            const direWon = winner === 'å¤œé­”';
            
            // æ£€æŸ¥å¤©è¾‰é˜Ÿ
            radiantPlayers.forEach(player => {
                if (radiantWon) {
                    // èƒœåˆ©æ–¹ä¸åº”è¯¥æœ‰ SVP æˆ– åƒµ
                    if (player.tags.includes('SVP')) {
                        warnings.push(`âš ï¸ ${player.name} æ˜¯èƒœåˆ©æ–¹ä½†æœ‰SVPæ ‡ç­¾`);
                    }
                    if (player.tags.includes('åƒµ')) {
                        warnings.push(`âš ï¸ ${player.name} æ˜¯èƒœåˆ©æ–¹ä½†æœ‰åƒµæ ‡ç­¾`);
                    }
                } else {
                    // å¤±è´¥æ–¹ä¸åº”è¯¥æœ‰ MVP
                    if (player.tags.includes('MVP')) {
                        warnings.push(`âš ï¸ ${player.name} æ˜¯å¤±è´¥æ–¹ä½†æœ‰MVPæ ‡ç­¾`);
                    }
                }
            });
            
            // æ£€æŸ¥å¤œé­”é˜Ÿ
            direPlayers.forEach(player => {
                if (direWon) {
                    // èƒœåˆ©æ–¹ä¸åº”è¯¥æœ‰ SVP æˆ– åƒµ
                    if (player.tags.includes('SVP')) {
                        warnings.push(`âš ï¸ ${player.name} æ˜¯èƒœåˆ©æ–¹ä½†æœ‰SVPæ ‡ç­¾`);
                    }
                    if (player.tags.includes('åƒµ')) {
                        warnings.push(`âš ï¸ ${player.name} æ˜¯èƒœåˆ©æ–¹ä½†æœ‰åƒµæ ‡ç­¾`);
                    }
                } else {
                    // å¤±è´¥æ–¹ä¸åº”è¯¥æœ‰ MVP
                    if (player.tags.includes('MVP')) {
                        warnings.push(`âš ï¸ ${player.name} æ˜¯å¤±è´¥æ–¹ä½†æœ‰MVPæ ‡ç­¾`);
                    }
                }
            });
            
            return warnings;
        }

        // æäº¤æ¯”èµ›
        function submitMatch() {
            if (!selectedWinner) {
                showToast('è¯·é€‰æ‹©è·èƒœæ–¹', 'error');
                return;
            }
            
            const radiantPlayers = [];
            const direPlayers = [];
            
            // æ”¶é›†å¤©è¾‰ç©å®¶ï¼ˆè‡ªåŠ¨ä¿®æ­£åå­—ï¼‰
            for (let i = 0; i < 5; i++) {
                const rawName = document.getElementById(`radiant_player_${i}`).value.trim();
                const name = correctPlayerName(rawName);
                if (name) {
                    // å¦‚æœåå­—è¢«ä¿®æ­£ï¼Œæ›´æ–°è¾“å…¥æ¡†
                    if (name !== rawName) {
                        document.getElementById(`radiant_player_${i}`).value = name;
                    }
                    const tags = [];
                    document.querySelectorAll(`#radiantPlayers .player-row:nth-child(${i+1}) .tag-btn.selected`).forEach(btn => {
                        tags.push(btn.textContent.trim());
                    });
                    radiantPlayers.push({ name, tags });
                }
            }
            
            // æ”¶é›†å¤œé­”ç©å®¶ï¼ˆè‡ªåŠ¨ä¿®æ­£åå­—ï¼‰
            for (let i = 0; i < 5; i++) {
                const rawName = document.getElementById(`dire_player_${i}`).value.trim();
                const name = correctPlayerName(rawName);
                if (name) {
                    // å¦‚æœåå­—è¢«ä¿®æ­£ï¼Œæ›´æ–°è¾“å…¥æ¡†
                    if (name !== rawName) {
                        document.getElementById(`dire_player_${i}`).value = name;
                    }
                    const tags = [];
                    document.querySelectorAll(`#direPlayers .player-row:nth-child(${i+1}) .tag-btn.selected`).forEach(btn => {
                        tags.push(btn.textContent.trim());
                    });
                    direPlayers.push({ name, tags });
                }
            }
            
            if (radiantPlayers.length === 0 && direPlayers.length === 0) {
                showToast('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç©å®¶', 'error');
                return;
            }
            
            // æ£€æŸ¥ç§°å·ä¸€è‡´æ€§
            const warnings = checkTagsConsistency(selectedWinner, radiantPlayers, direPlayers);
            if (warnings.length > 0) {
                const confirmMsg = warnings.join('\n') + '\n\nç§°å·ä¸èƒœè´Ÿä¸ä¸€è‡´ï¼Œæ˜¯å¦ç»§ç»­æäº¤ï¼Ÿ\nï¼ˆMVPåªèƒ½åœ¨èƒœåˆ©æ–¹ï¼ŒSVPå’Œåƒµåªèƒ½åœ¨å¤±è´¥æ–¹ï¼‰';
                if (!confirm(confirmMsg)) {
                    return;
                }
            }
            
            const matchData = {
                winner: selectedWinner,
                radiant_players: radiantPlayers,
                dire_players: direPlayers
            };
            
            fetch('/api/match', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(matchData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('æ¯”èµ›è®°å½•å·²ä¿å­˜ï¼', 'success');
                    resetForm();
                } else {
                    showToast(data.error || 'ä¿å­˜å¤±è´¥', 'error');
                }
            })
            .catch(err => {
                showToast('æäº¤å¤±è´¥: ' + err.message, 'error');
            });
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            selectedWinner = '';
            document.querySelectorAll('.winner-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.player-row input').forEach(input => input.value = '');
            document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('previewContainer').classList.remove('visible');
            document.getElementById('fileInput').value = '';
        }

        // åŠ è½½æ’è¡Œæ¦œ
        function loadLeaderboard() {
            const loading = document.getElementById('leaderboardLoading');
            const content = document.getElementById('leaderboardContent');
            const empty = document.getElementById('leaderboardEmpty');
            
            loading.classList.add('visible');
            content.style.display = 'none';
            empty.style.display = 'none';
            
            fetch('/api/leaderboard')
            .then(res => res.json())
            .then(players => {
                loading.classList.remove('visible');
                
                if (players.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                currentPlayers = players;
                content.style.display = 'block';
                renderLeaderboard();
            })
            .catch(err => {
                loading.classList.remove('visible');
                showToast('åŠ è½½å¤±è´¥: ' + err.message, 'error');
            });
        }

        // æ¸²æŸ“æ’è¡Œæ¦œ
        function renderLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            
            // é‡æ–°è®¡ç®—æ’å
            currentPlayers.forEach((player, index) => {
                const tr = document.createElement('tr');
                const scoreClass = player.score > 0 ? 'positive' : (player.score < 0 ? 'negative' : 'zero');
                const displayRank = index + 1;
                const rankClass = displayRank <= 3 ? `rank-${displayRank}` : '';
                
                const horseLevel = player.horse_level || '';
                const horseValue = player.horse_value;
                const hasHorse = horseLevel !== '';
                const horseColor = horseLevel === 'ç‰¹ç­‰' ? '#ffd700' : (horseLevel === 'è‡ªåŠ¨' ? '#e74c3c' : '#95a5a6');
                const horseIcon = horseLevel === 'ç‰¹ç­‰' ? 'ğŸ†' : (horseLevel === 'è‡ªåŠ¨' ? 'ğŸ´' : 'ğŸ');
                const horseDisplay = hasHorse 
                    ? `<span style="color: ${horseColor}; font-weight: 600;">${horseIcon} ${horseLevel}<span style="font-size: 0.75rem; opacity: 0.7;">(${horseValue >= 0 ? '+' : ''}${horseValue})</span></span>`
                    : '<span style="color: var(--text-muted);">-</span>';
                
                tr.innerHTML = `
                    <td class="rank ${rankClass}">#${displayRank}</td>
                    <td>
                        <span class="player-name" onclick="showPlayerDetail('${player.name}')">
                            ${player.name}
                        </span>
                    </td>
                    <td class="score ${scoreClass}">${player.score > 0 ? '+' : ''}${Number.isInteger(player.score) ? player.score : player.score.toFixed(1)}</td>
                    <td>${player.total_games}</td>
                    <td style="color: var(--accent-green)">${player.wins}</td>
                    <td style="color: var(--accent-red)">${player.losses}</td>
                    <td>
                        <div class="win-rate">
                            <div class="win-rate-bar">
                                <div class="win-rate-fill" style="width: ${player.win_rate}%"></div>
                            </div>
                            <span>${player.win_rate}%</span>
                        </div>
                    </td>
                    <td>${(player.mvp_count || 0) > 0 ? `<span class="tag-badge mvp">MVPÃ—${player.mvp_count}</span>` : '<span style="color: var(--text-muted)">0</span>'}</td>
                    <td>${(player.svp_count || 0) > 0 ? `<span class="tag-badge svp">SVPÃ—${player.svp_count}</span>` : '<span style="color: var(--text-muted)">0</span>'}</td>
                    <td>${(player.jiang_count || 0) > 0 ? `<span class="tag-badge jiang">åƒµÃ—${player.jiang_count}</span>` : '<span style="color: var(--text-muted)">0</span>'}</td>
                    <td>${horseDisplay}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ’åºè¡¨æ ¼
        function sortTable(column) {
            // æ›´æ–°æ’åºæ–¹å‘
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'desc' ? 'asc' : 'desc';
            } else {
                sortState.column = column;
                // ç©å®¶åé»˜è®¤å‡åºï¼Œå…¶ä»–é»˜è®¤é™åº
                sortState.direction = column === 'name' ? 'asc' : 'desc';
            }

            // æ›´æ–°æ’åºå›¾æ ‡
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = 'â†•';
                icon.classList.remove('active');
            });
            const activeIcon = document.getElementById(`sort-${column}`);
            if (activeIcon) {
                activeIcon.textContent = sortState.direction === 'desc' ? 'â†“' : 'â†‘';
                activeIcon.classList.add('active');
            }

            // æ’åº
            currentPlayers.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // ç©å®¶åæŒ‰å­—æ¯æ’åº
                if (column === 'name') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                    if (sortState.direction === 'asc') {
                        return valA.localeCompare(valB, 'zh-CN');
                    } else {
                        return valB.localeCompare(valA, 'zh-CN');
                    }
                }

                // æ•°å€¼æ’åº
                if (sortState.direction === 'desc') {
                    return valB - valA;
                } else {
                    return valA - valB;
                }
            });

            renderLeaderboard();
        }

        // åŠ è½½æ¯”èµ›è®°å½•
        function loadMatches() {
            const loading = document.getElementById('historyLoading');
            const content = document.getElementById('historyContent');
            const empty = document.getElementById('historyEmpty');
            
            loading.classList.add('visible');
            content.style.display = 'none';
            empty.style.display = 'none';
            
            fetch('/api/matches')
            .then(res => res.json())
            .then(matches => {
                loading.classList.remove('visible');
                
                if (matches.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                content.style.display = 'block';
                content.innerHTML = '';
                
                matches.forEach(match => {
                    const card = document.createElement('div');
                    card.className = 'match-card';
                    
                    const radiantWon = match.winner === 'å¤©è¾‰';
                    const direWon = match.winner === 'å¤œé­”';
                    
                    card.innerHTML = `
                        <div class="match-header">
                            <span class="match-date">ğŸ“… ${match.date || match.timestamp?.split('T')[0] || 'æœªçŸ¥æ—¥æœŸ'} | ç¬¬${match.id}åœº</span>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="editMatch(${match.id})" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                                    âœï¸ ç¼–è¾‘
                                </button>
                                <button class="btn btn-danger" onclick="deleteMatch(${match.id})" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </div>
                        <div class="match-result">
                            <div class="match-team ${radiantWon ? 'winner' : ''}">
                                <h5><span class="team-badge radiant">å¤©è¾‰</span> ${radiantWon ? 'èƒœåˆ©' : 'å¤±è´¥'}</h5>
                                ${match.radiant_players?.map(p => `
                                    <div class="match-player">
                                        <span class="match-player-name">${p.name}</span>
                                        <div class="match-player-tags">
                                            ${p.tags?.map(t => `<span class="tag-badge ${t.toLowerCase()}">${t}</span>`).join('') || ''}
                                        </div>
                                    </div>
                                `).join('') || '<p style="color: var(--text-muted)">æ— ç©å®¶æ•°æ®</p>'}
                            </div>
                            <div class="match-team ${direWon ? 'winner' : ''}">
                                <h5><span class="team-badge dire">å¤œé­”</span> ${direWon ? 'èƒœåˆ©' : 'å¤±è´¥'}</h5>
                                ${match.dire_players?.map(p => `
                                    <div class="match-player">
                                        <span class="match-player-name">${p.name}</span>
                                        <div class="match-player-tags">
                                            ${p.tags?.map(t => `<span class="tag-badge ${t.toLowerCase()}">${t}</span>`).join('') || ''}
                                        </div>
                                    </div>
                                `).join('') || '<p style="color: var(--text-muted)">æ— ç©å®¶æ•°æ®</p>'}
                            </div>
                        </div>
                    `;
                    content.appendChild(card);
                });
            })
            .catch(err => {
                loading.classList.remove('visible');
                showToast('åŠ è½½å¤±è´¥: ' + err.message, 'error');
            });
        }

        // åˆ é™¤æ¯”èµ›
        function deleteMatch(matchId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™åœºæ¯”èµ›è®°å½•å—ï¼Ÿ')) return;
            
            fetch(`/api/match/${matchId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('æ¯”èµ›è®°å½•å·²åˆ é™¤', 'success');
                    loadMatches();
                } else {
                    showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(err => {
                showToast('åˆ é™¤å¤±è´¥: ' + err.message, 'error');
            });
        }

        // ç¼–è¾‘æ¯”èµ›ç›¸å…³
        let editingMatchId = null;
        let editSelectedWinner = '';

        function editMatch(matchId) {
            fetch(`/api/match/${matchId}`)
            .then(res => res.json())
            .then(match => {
                if (match.error) {
                    showToast(match.error, 'error');
                    return;
                }
                
                editingMatchId = matchId;
                document.getElementById('editMatchId').textContent = `#${matchId}`;
                
                // åˆå§‹åŒ–ç¼–è¾‘è¡¨å•çš„ç©å®¶è¾“å…¥æ¡†
                initEditPlayerInputs();
                
                // å¡«å……è·èƒœæ–¹
                editSelectedWinner = match.winner;
                document.getElementById('editWinnerRadiant').classList.remove('selected');
                document.getElementById('editWinnerDire').classList.remove('selected');
                if (match.winner === 'å¤©è¾‰') {
                    document.getElementById('editWinnerRadiant').classList.add('selected');
                } else if (match.winner === 'å¤œé­”') {
                    document.getElementById('editWinnerDire').classList.add('selected');
                }
                
                // å¡«å……å¤©è¾‰ç©å®¶
                (match.radiant_players || []).forEach((player, i) => {
                    if (i < 5) {
                        const input = document.getElementById(`edit_radiant_player_${i}`);
                        if (input) input.value = player.name || '';
                        
                        // è®¾ç½®æ ‡ç­¾
                        (player.tags || []).forEach(tag => {
                            document.querySelectorAll(`#editRadiantPlayers .player-row:nth-child(${i+1}) .tag-btn`).forEach(btn => {
                                if (btn.textContent.trim() === tag) btn.classList.add('selected');
                            });
                        });
                    }
                });
                
                // å¡«å……å¤œé­”ç©å®¶
                (match.dire_players || []).forEach((player, i) => {
                    if (i < 5) {
                        const input = document.getElementById(`edit_dire_player_${i}`);
                        if (input) input.value = player.name || '';
                        
                        (player.tags || []).forEach(tag => {
                            document.querySelectorAll(`#editDirePlayers .player-row:nth-child(${i+1}) .tag-btn`).forEach(btn => {
                                if (btn.textContent.trim() === tag) btn.classList.add('selected');
                            });
                        });
                    }
                });
                
                document.getElementById('editMatchModal').classList.add('visible');
            })
            .catch(err => {
                showToast('åŠ è½½å¤±è´¥: ' + err.message, 'error');
            });
        }

        function initEditPlayerInputs() {
            const radiantContainer = document.getElementById('editRadiantPlayers');
            const direContainer = document.getElementById('editDirePlayers');
            
            radiantContainer.innerHTML = '';
            direContainer.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                radiantContainer.appendChild(createEditPlayerInput('radiant', i));
                direContainer.appendChild(createEditPlayerInput('dire', i));
            }
        }

        function createEditPlayerInput(team, index) {
            const div = document.createElement('div');
            div.className = 'player-row';
            div.innerHTML = `
                <input type="text" id="edit_${team}_player_${index}" placeholder="ç©å®¶åç§°">
                <div class="tags-container">
                    ${TAGS.map(tag => `
                        <button class="tag-btn ${tag.toLowerCase()}" 
                                onclick="this.classList.toggle('selected')">
                            ${tag}
                        </button>
                    `).join('')}
                </div>
            `;
            return div;
        }

        function selectEditWinner(team) {
            editSelectedWinner = team;
            document.getElementById('editWinnerRadiant').classList.remove('selected');
            document.getElementById('editWinnerDire').classList.remove('selected');
            document.getElementById(team === 'å¤©è¾‰' ? 'editWinnerRadiant' : 'editWinnerDire').classList.add('selected');
        }

        function swapEditTeams() {
            // æ”¶é›†å¤©è¾‰ç©å®¶æ•°æ®
            const radiantData = [];
            for (let i = 0; i < 5; i++) {
                const name = document.getElementById(`edit_radiant_player_${i}`).value;
                const tags = [];
                document.querySelectorAll(`#editRadiantPlayers .player-row:nth-child(${i+1}) .tag-btn.selected`).forEach(btn => {
                    tags.push(btn.textContent.trim());
                });
                radiantData.push({ name, tags });
            }

            // æ”¶é›†å¤œé­”ç©å®¶æ•°æ®
            const direData = [];
            for (let i = 0; i < 5; i++) {
                const name = document.getElementById(`edit_dire_player_${i}`).value;
                const tags = [];
                document.querySelectorAll(`#editDirePlayers .player-row:nth-child(${i+1}) .tag-btn.selected`).forEach(btn => {
                    tags.push(btn.textContent.trim());
                });
                direData.push({ name, tags });
            }

            // æ¸…ç©ºæ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#editMatchModal .tag-btn').forEach(btn => btn.classList.remove('selected'));

            // äº¤æ¢æ•°æ®
            for (let i = 0; i < 5; i++) {
                document.getElementById(`edit_radiant_player_${i}`).value = direData[i].name;
                direData[i].tags.forEach(tag => {
                    document.querySelectorAll(`#editRadiantPlayers .player-row:nth-child(${i+1}) .tag-btn`).forEach(b => {
                        if (b.textContent.trim() === tag) b.classList.add('selected');
                    });
                });

                document.getElementById(`edit_dire_player_${i}`).value = radiantData[i].name;
                radiantData[i].tags.forEach(tag => {
                    document.querySelectorAll(`#editDirePlayers .player-row:nth-child(${i+1}) .tag-btn`).forEach(b => {
                        if (b.textContent.trim() === tag) b.classList.add('selected');
                    });
                });
            }

            // äº¤æ¢è·èƒœæ–¹
            if (editSelectedWinner === 'å¤©è¾‰') {
                selectEditWinner('å¤œé­”');
            } else if (editSelectedWinner === 'å¤œé­”') {
                selectEditWinner('å¤©è¾‰');
            }

            showToast('é˜µè¥å·²äº¤æ¢', 'success');
        }

        function saveMatchEdit() {
            if (!editSelectedWinner) {
                showToast('è¯·é€‰æ‹©è·èƒœæ–¹', 'error');
                return;
            }
            
            const radiantPlayers = [];
            const direPlayers = [];
            
            // æ”¶é›†å¤©è¾‰ç©å®¶ï¼ˆè‡ªåŠ¨ä¿®æ­£åå­—ï¼‰
            for (let i = 0; i < 5; i++) {
                const rawName = document.getElementById(`edit_radiant_player_${i}`).value.trim();
                const name = correctPlayerName(rawName);
                if (name) {
                    if (name !== rawName) {
                        document.getElementById(`edit_radiant_player_${i}`).value = name;
                    }
                    const tags = [];
                    document.querySelectorAll(`#editRadiantPlayers .player-row:nth-child(${i+1}) .tag-btn.selected`).forEach(btn => {
                        tags.push(btn.textContent.trim());
                    });
                    radiantPlayers.push({ name, tags });
                }
            }
            
            // æ”¶é›†å¤œé­”ç©å®¶ï¼ˆè‡ªåŠ¨ä¿®æ­£åå­—ï¼‰
            for (let i = 0; i < 5; i++) {
                const rawName = document.getElementById(`edit_dire_player_${i}`).value.trim();
                const name = correctPlayerName(rawName);
                if (name) {
                    if (name !== rawName) {
                        document.getElementById(`edit_dire_player_${i}`).value = name;
                    }
                    const tags = [];
                    document.querySelectorAll(`#editDirePlayers .player-row:nth-child(${i+1}) .tag-btn.selected`).forEach(btn => {
                        tags.push(btn.textContent.trim());
                    });
                    direPlayers.push({ name, tags });
                }
            }
            
            if (radiantPlayers.length === 0 && direPlayers.length === 0) {
                showToast('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç©å®¶', 'error');
                return;
            }
            
            // æ£€æŸ¥ç§°å·ä¸€è‡´æ€§
            const warnings = checkTagsConsistency(editSelectedWinner, radiantPlayers, direPlayers);
            if (warnings.length > 0) {
                const confirmMsg = warnings.join('\n') + '\n\nç§°å·ä¸èƒœè´Ÿä¸ä¸€è‡´ï¼Œæ˜¯å¦ç»§ç»­ä¿å­˜ï¼Ÿ\nï¼ˆMVPåªèƒ½åœ¨èƒœåˆ©æ–¹ï¼ŒSVPå’Œåƒµåªèƒ½åœ¨å¤±è´¥æ–¹ï¼‰';
                if (!confirm(confirmMsg)) {
                    return;
                }
            }
            
            const matchData = {
                winner: editSelectedWinner,
                radiant_players: radiantPlayers,
                dire_players: direPlayers
            };
            
            fetch(`/api/match/${editingMatchId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(matchData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('æ¯”èµ›è®°å½•å·²æ›´æ–°ï¼', 'success');
                    closeEditModal();
                    loadMatches();
                } else {
                    showToast(data.error || 'æ›´æ–°å¤±è´¥', 'error');
                }
            })
            .catch(err => {
                showToast('æ›´æ–°å¤±è´¥: ' + err.message, 'error');
            });
        }

        function closeEditModal() {
            document.getElementById('editMatchModal').classList.remove('visible');
            editingMatchId = null;
            editSelectedWinner = '';
        }

        // ç‚¹å‡»ç¼–è¾‘å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('editMatchModal').addEventListener('click', (e) => {
            if (e.target.id === 'editMatchModal') closeEditModal();
        });

        // æ˜¾ç¤ºç©å®¶è¯¦æƒ…
        function showPlayerDetail(name) {
            fetch(`/api/player/${encodeURIComponent(name)}`)
            .then(res => res.json())
            .then(player => {
                if (player.error) {
                    showToast(player.error, 'error');
                    return;
                }
                
                document.getElementById('modalPlayerName').textContent = player.name;
                
                const scoreClass = player.score > 0 ? 'positive' : (player.score < 0 ? 'negative' : 'zero');
                
                const displayScore = Number.isInteger(player.score) ? player.score : player.score.toFixed(1);
                let html = `
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-value ${scoreClass}">${player.score > 0 ? '+' : ''}${displayScore}</div>
                            <div class="stat-label">ç§¯åˆ†</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${player.total_games}</div>
                            <div class="stat-label">æ€»åœºæ¬¡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--accent-green)">${player.wins}</div>
                            <div class="stat-label">èƒœåœº</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--accent-red)">${player.losses}</div>
                            <div class="stat-label">è´Ÿåœº</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${player.win_rate}%</div>
                            <div class="stat-label">èƒœç‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #ffd700">${player.mvp_count || 0}</div>
                            <div class="stat-label">MVP</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #9b59b6">${player.svp_count || 0}</div>
                            <div class="stat-label">SVP</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #7f8c8d">${player.jiang_count || 0}</div>
                            <div class="stat-label">åƒµ</div>
                        </div>
                    </div>
                `;
                
                // é˜Ÿå‹èƒœç‡ï¼ˆæœ€ä½³æ­æ¡£ï¼‰
                if (player.teammate_stats && player.teammate_stats.length > 0) {
                    html += `
                        <div class="relation-section">
                            <h4>ğŸ¤ é˜Ÿå‹èƒœç‡ <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal;">ï¼ˆæœ€ä½³æ­æ¡£ï¼‰</span></h4>
                            <table class="relation-table">
                                <thead>
                                    <tr><th>é˜Ÿå‹</th><th>åŒé˜Ÿåœºæ¬¡</th><th>ä¸€èµ·èµ¢</th><th>èƒœç‡</th></tr>
                                </thead>
                                <tbody>
                                    ${player.teammate_stats.map(t => `
                                        <tr>
                                            <td>${t.name}</td>
                                            <td>${t.games}</td>
                                            <td>${t.wins}</td>
                                            <td style="color: ${t.win_rate >= 50 ? 'var(--accent-green)' : 'var(--accent-red)'}">
                                                ${t.win_rate}%
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                // å¯¹æ‰‹èƒœç‡ï¼ˆé‡åˆ°è°è¾“å¾—å¤šï¼‰
                if (player.opponent_stats && player.opponent_stats.length > 0) {
                    html += `
                        <div class="relation-section">
                            <h4>âš”ï¸ å…‹æ˜Ÿæ¦œ <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal;">ï¼ˆé‡åˆ°è°è¾“å¾—å¤šï¼‰</span></h4>
                            <table class="relation-table">
                                <thead>
                                    <tr><th>å¯¹æ‰‹</th><th>äº¤æ‰‹åœºæ¬¡</th><th>å¯¹é¢èµ¢</th><th>å¯¹é¢èƒœç‡</th></tr>
                                </thead>
                                <tbody>
                                    ${player.opponent_stats.map(t => `
                                        <tr>
                                            <td>${t.name}</td>
                                            <td>${t.games}</td>
                                            <td>${t.wins}</td>
                                            <td style="color: ${t.win_rate >= 50 ? 'var(--accent-red)' : 'var(--accent-green)'}">
                                                ${t.win_rate}%
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                document.getElementById('modalContent').innerHTML = html;
                document.getElementById('playerModal').classList.add('visible');
            })
            .catch(err => {
                showToast('åŠ è½½å¤±è´¥: ' + err.message, 'error');
            });
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('playerModal').classList.remove('visible');
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('playerModal').addEventListener('click', (e) => {
            if (e.target.id === 'playerModal') closeModal();
        });

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            fetch('/api/export')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('æ•°æ®å·²å¯¼å‡ºåˆ° ' + data.filename, 'success');
                    // ä¸‹è½½æ–‡ä»¶
                    window.open(`/api/download/${data.filename}`, '_blank');
                } else {
                    showToast(data.error || 'å¯¼å‡ºå¤±è´¥', 'error');
                }
            })
            .catch(err => {
                showToast('å¯¼å‡ºå¤±è´¥: ' + err.message, 'error');
            });
        }

        // å¯¼å‡ºç§¯åˆ†æ¦œä¸ºé•¿å›¾
        async function exportLeaderboardImage() {
            if (currentPlayers.length === 0) {
                showToast('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }

            showToast('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...', 'info');

            // åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºå¯¼å‡ºçš„å®¹å™¨
            const exportContainer = document.createElement('div');
            exportContainer.id = 'exportContainer';
            exportContainer.style.cssText = `
                position: fixed;
                left: -9999px;
                top: 0;
                width: 900px;
                background: linear-gradient(180deg, #0a0e17 0%, #131a26 100%);
                padding: 30px;
                font-family: 'Noto Sans SC', sans-serif;
                color: #ecf0f1;
            `;

            // ç”Ÿæˆè¡¨æ ¼HTML
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            let tableHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h1 style="font-family: 'Orbitron', sans-serif; font-size: 28px; color: #f5a623; margin: 0;">
                        DOTA4+2 é£é¾™åœ¨å¤©
                    </h1>
                    <p style="color: #95a5a6; font-size: 14px; margin-top: 8px;">å¯¹é»‘ç§¯åˆ†æ¦œ | ${dateStr}</p>
                </div>
                <table style="width: 100%; border-collapse: collapse; background: #1a2332; border-radius: 10px; overflow: hidden;">
                    <thead>
                        <tr style="background: #243044;">
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">æ’å</th>
                            <th style="padding: 12px 8px; text-align: left; color: #95a5a6; font-size: 12px;">ç©å®¶</th>
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">ç§¯åˆ†</th>
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">æ€»åœº</th>
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">èƒœ</th>
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">è´Ÿ</th>
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">èƒœç‡</th>
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">MVP</th>
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">SVP</th>
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">åƒµ</th>
                            <th style="padding: 12px 8px; text-align: center; color: #95a5a6; font-size: 12px;">é©¬åŒ¹</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            currentPlayers.forEach((player, index) => {
                const rank = index + 1;
                const rankColor = rank === 1 ? '#ffd700' : (rank === 2 ? '#c0c0c0' : (rank === 3 ? '#cd7f32' : '#ecf0f1'));
                const scoreColor = player.score > 0 ? '#2ecc71' : (player.score < 0 ? '#e74c3c' : '#95a5a6');
                const scoreDisplay = Number.isInteger(player.score) ? player.score : player.score.toFixed(1);
                const winRateColor = player.win_rate >= 50 ? '#2ecc71' : '#e74c3c';
                const horseLevel = player.horse_level || '';
                const horseValue = player.horse_value;
                const hasHorse = horseLevel !== '';
                const horseColor = horseLevel === 'ç‰¹ç­‰' ? '#ffd700' : (horseLevel === 'è‡ªåŠ¨' ? '#e74c3c' : '#95a5a6');
                const horseDisplay = hasHorse ? `${horseLevel}(${horseValue >= 0 ? '+' : ''}${horseValue})` : '-';

                tableHTML += `
                    <tr style="border-bottom: 1px solid #2c3e50;">
                        <td style="padding: 10px 8px; text-align: center; font-family: 'Orbitron', sans-serif; font-weight: bold; color: ${rankColor};">#${rank}</td>
                        <td style="padding: 10px 8px; text-align: left; font-weight: 600;">${player.name}</td>
                        <td style="padding: 10px 8px; text-align: center; font-family: 'Orbitron', sans-serif; font-weight: bold; color: ${scoreColor};">${player.score > 0 ? '+' : ''}${scoreDisplay}</td>
                        <td style="padding: 10px 8px; text-align: center;">${player.total_games}</td>
                        <td style="padding: 10px 8px; text-align: center; color: #2ecc71;">${player.wins}</td>
                        <td style="padding: 10px 8px; text-align: center; color: #e74c3c;">${player.losses}</td>
                        <td style="padding: 10px 8px; text-align: center; color: ${winRateColor};">${player.win_rate}%</td>
                        <td style="padding: 10px 8px; text-align: center;">${(player.mvp_count || 0) > 0 ? `<span style="background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 11px;">MVPÃ—${player.mvp_count}</span>` : '<span style="color: #5d6d7e;">0</span>'}</td>
                        <td style="padding: 10px 8px; text-align: center;">${(player.svp_count || 0) > 0 ? `<span style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 11px;">SVPÃ—${player.svp_count}</span>` : '<span style="color: #5d6d7e;">0</span>'}</td>
                        <td style="padding: 10px 8px; text-align: center;">${(player.jiang_count || 0) > 0 ? `<span style="background: #7f8c8d; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 11px;">åƒµÃ—${player.jiang_count}</span>` : '<span style="color: #5d6d7e;">0</span>'}</td>
                        <td style="padding: 10px 8px; text-align: center; color: ${hasHorse ? horseColor : '#5d6d7e'}; font-weight: 600;">${horseDisplay}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
                <div style="text-align: center; margin-top: 20px; color: #5d6d7e; font-size: 12px;">
                    ç§¯åˆ†è§„åˆ™ï¼šèƒœ+1 è´Ÿ-1 | MVP+0.5 SVP+0.5 åƒµ-0.5 | é˜µå®¹å·®è·1åˆ†è¡¥0.5åˆ†
                </div>
            `;

            exportContainer.innerHTML = tableHTML;
            document.body.appendChild(exportContainer);

            try {
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#0a0e17',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });

                // ä¸‹è½½å›¾ç‰‡
                const link = document.createElement('a');
                link.download = `ç§¯åˆ†æ¦œ_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                showToast('å›¾ç‰‡å·²ä¿å­˜', 'success');
            } catch (err) {
                showToast('å¯¼å‡ºå¤±è´¥: ' + err.message, 'error');
            } finally {
                document.body.removeChild(exportContainer);
            }
        }

        // Toasté€šçŸ¥
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'âœ…' : (type === 'error' ? 'âŒ' : 'â„¹ï¸');
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>

